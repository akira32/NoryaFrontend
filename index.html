<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheet Data Viewer</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f8fa;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #4caf50;
      color: white;
    }
    img.table-img {
      width: 80px;
      height: auto;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ddd;
      background: #fafafa;
    }
  </style>
</head>
<body>

  <h1>Norya遊戲模擬器</h1>
  <p id="loading">資料讀取中...</p>
  <p id="error"></p>

  <table id="sheetTable" style="display:none;">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    // 判斷是否為圖片連結
    function isImageUrl(url) {
      if (!url) return false;
      const lower = url.toLowerCase();
      return (
        lower.endsWith('.jpg') ||
        lower.endsWith('.jpeg') ||
        lower.endsWith('.png') ||
        lower.endsWith('.gif') ||
        lower.endsWith('.webp') ||
        lower.endsWith('.svg') ||
        lower.includes("googleusercontent.com") ||   // Google Drive direct
        lower.includes("drive.google.com")           // Google Drive view link
      );
    }

    // 將 Google Drive 分享連結轉成縮圖
    function driveToThumbnail(url) {
      if (!url.includes("drive.google.com")) return url;

      const match = url.match(/\/d\/(.*?)\//);
      if (!match) return url;

      const id = match[1];
      return `https://drive.google.com/thumbnail?id=${id}&sz=w200`;
    }

    async function loadSheetData() {
      try {
        const response = await fetch("http://localhost:3000/api/sheet-data");
        const json = await response.json();

        if (!json.success) {
          document.getElementById("error").textContent = "後端回傳錯誤：" + json.message;
          return;
        }

        const rows = json.rows;
        document.getElementById("loading").style.display = "none";
        document.getElementById("sheetTable").style.display = "table";

        const thead = document.getElementById("thead");
        const tbody = document.getElementById("tbody");

        const columns = Object.keys(rows[0]);

        // --- 表頭 ---
        thead.innerHTML = `
          <tr>${columns.map(col => `<th>${col}</th>`).join("")}</tr>
        `;

        // --- 表格內容 ---
        tbody.innerHTML = rows
          .map(row => {
            return `
              <tr>
                ${columns
                  .map(col => {
                    const value = row[col] ?? "";

                    // 如果是圖片連結 → 顯示 <img>
                    if (isImageUrl(value)) {
                      const imgUrl = driveToThumbnail(value);
                      return `<td><img class="table-img" src="${imgUrl}" alt=""></td>`;
                    }

                    // 文字欄位 → 一般顯示
                    return `<td>${value}</td>`;
                  })
                  .join("")}
              </tr>
            `;
          })
          .join("");
      } catch (err) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").textContent = "讀取失敗：" + err.message;
      }
    }

    loadSheetData();
  </script>

</body>
</html>
